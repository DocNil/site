<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Receituário Médico Profissional</title>
    <style>
        /* Estilos de Tela (Design Profissional) */
        body {
            font-family: Arial, sans-serif;
            background-color: #f0f0f0;
            margin: 0;
            padding: 20px;
        }
        .form-container {
            max-width: 800px;
            margin: 0 auto;
            background-color: #fff;
            padding: 30px;
            border: 1px solid #c0c0c0;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        /* Controles do Formulário */
        .form-group { margin-bottom: 10px; }
        label { font-weight: bold; display: block; margin-bottom: 3px; font-size: 14px; }
        input[type="text"], textarea {
            width: 100%;
            padding: 6px;
            border: 1px solid #ccc;
            border-radius: 5px; 
            box-sizing: border-box;
            font-size: 14px;
            min-height: 34px; 
        }
        textarea#prescricao-texto-livre {
            min-height: 250px; 
            font-family: 'Times New Roman', Times, serif; 
            font-size: 16px;
            padding: 10px;
        }
        .row { display: flex; gap: 20px; }
        .row .form-group { flex: 1; }
        .full-width { width: 100%; }
        
        /* Área de Prescrição (Múltiplos Campos) */
        #prescricao-fields { border: 1px dashed #aaa; padding: 15px; margin-top: 10px; background-color: #f9f9f9; border-radius: 5px; }
        .medicamento-item { display: flex; gap: 10px; margin-bottom: 15px; padding: 8px; border-bottom: 1px solid #ddd; }
        .med-col-med { flex: 4; }
        .med-col-qnt { flex: 1.2; }
        .med-col-pos { flex: 3; }
        .med-col-check { flex: 1.5; align-self: center; }

        /* Botões */
        .btn-acao { background-color: #007bff; color: white; padding: 10px 15px; border: none; border-radius: 5px; cursor: pointer; margin-top: 20px; font-size: 16px; transition: background-color 0.3s; }
        .btn-acao:hover { background-color: #0056b3; }
        #add-medicamento { background-color: #28a745; }
        #add-medicamento:hover { background-color: #1e7e34; }
        #novo-receituario { background-color: #ffc107; color: #333; }
        #novo-receituario:hover { background-color: #e0a800; }
        .btn-remover { background-color: #dc3545; color: white; border: none; border-radius: 3px; cursor: pointer; padding: 5px; margin-left: 5px; font-size: 12px; }

        /* Estilos de Impressão (Receituário) */
        @media print {
            @page { margin: 0; }
            body { margin: 0; padding: 0; background-color: white !important; }
            
            /* Ocultar elementos do formulário */
            .form-container, #print-button, #add-medicamento, #opcoes-controle, .med-col-check, .btn-remover, #novo-receituario, #opcoes-data, #toggle-prescricao {
                display: none !important;
            }
            
            /* Layout da Receita */
            .receituario {
                width: 100%;
                height: 98vh;
                padding: 15mm 15mm;
                box-sizing: border-box;
                page-break-after: always;
                font-family: 'Times New Roman', Times, serif;
                font-size: 12pt;
                color: #000;
                position: relative;
            }
            .receituario:last-child { page-break-after: avoid; }
            
            /* Cabeçalho */
            .cabecalho {
                text-align: center;
                border-bottom: 2px solid #000;
                padding-bottom: 8px;
                margin-bottom: 20px;
            }
            .cabecalho h1 { margin: 0; font-size: 18pt; font-weight: bold; }
            .cabecalho p { margin: 3px 0; font-size: 11pt; } 
            
            /* Dados do Paciente */
            .dados-paciente {
                border: 1px solid #000;
                padding: 8px;
                margin-bottom: 20px;
            }
            .dados-paciente p { margin: 4px 0; font-size: 11pt; }
            
            /* Área de Prescrição (Retângulo) */
            .prescricao-print {
                min-height: 45%; 
                border: 2px solid #000; 
                padding: 10px;
                margin-bottom: 15px; 
            }
            /* Estilo para lista padrão (Campos Separados) */
            .prescricao-print ol {
                list-style-type: decimal;
                padding-left: 20px;
                margin-top: 5px;
            }
            .prescricao-print li {
                margin-bottom: 12px;
                line-height: 1.3;
                padding-bottom: 3px;
            }
            .prescricao-print strong {
                font-size: 13pt;
                display: block;
                margin-bottom: 2px;
            }
            .uso-continuo {
                font-style: italic;
                font-size: 11pt;
                color: #000;
                display: inline;
                margin-left: 5px;
            }
            /* Estilo para Texto Livre na impressão - Remove recuos */
            .prescricao-print .texto-livre-print {
                white-space: pre-wrap;
                margin: 0;
                padding: 0;
            }

            /* Identificação da Farmácia */
            .identificacao-farmacia {
                border: 1px solid #000;
                padding: 8px;
                margin-top: 10px;
                font-size: 9pt;
            }
            .identificacao-farmacia .titulo { font-weight: bold; margin-bottom: 5px; text-decoration: underline; }
            .identificacao-farmacia .bloco { display: flex; gap: 15px; margin-bottom: 5px; }
            .identificacao-farmacia .campo { flex: 1; border-bottom: 1px dashed #000; padding-bottom: 2px; }
            .identificacao-farmacia .campo-metade { flex: 1; border-bottom: 1px dashed #000; padding-bottom: 2px; } 
            .identificacao-farmacia .campo-longo { flex: 2; border-bottom: 1px dashed #000; padding-bottom: 2px; }
            .identificacao-farmacia .campo-inteiro { width: 100%; border-bottom: 1px dashed #000; padding-bottom: 2px; } 
            
            /* Rodapé - Assinatura */
            .assinatura {
                position: absolute;
                bottom: 15mm;
                left: 15mm;
                right: 15mm;
                display: flex;
                justify-content: space-between;
                align-items: flex-end;
            }
            .assinatura .data {
                text-align: left;
                font-size: 11pt;
                flex: 1;
            }
            .assinatura .data .data-manual {
                text-decoration: underline;
                display: inline-block;
                width: 120px; 
                height: 16px; 
                vertical-align: middle;
            }

            .assinatura .bloco-medico {
                flex: 1;
                text-align: center;
                margin-top: 20px; 
            }
            .assinatura .linha-assinatura {
                width: 80%;
                border-top: 1px solid #000; 
                margin: 0 auto;
                margin-bottom: 5px; 
            }
            .assinatura .medico-info {
                font-size: 10pt;
            }
            
            /* Aviso de Via para Controle Especial */
            .via-info {
                position: absolute;
                top: 5mm;
                right: 15mm;
                font-size: 10pt;
                font-weight: bold;
                color: #dc3545;
            }
        }
    </style>
</head>
<body onload="carregarDadosMedico()">

<div class="form-container">
    <h1>Receituário Médico</h1>
    
    <div style="display: flex; justify-content: space-between; align-items: flex-end;">
        <button id="novo-receituario" class="btn-acao" onclick="novoReceituario()">Novo Receituário</button>
        <div id="opcoes-data" class="form-group">
            <label>
                <input type="checkbox" id="data-automatica" checked>
                **Data Automática**
            </label>
        </div>
        <div id="opcoes-controle" class="form-group">
            <label>
                <input type="checkbox" id="controle-especial">
                **Receita de Controle Especial (Duas Vias)**
            </label>
        </div>
    </div>
    

    <hr style="margin: 10px 0;">

    <h2>Dados do Médico (Salvos Localmente)</h2>
    <div class="row">
        <div class="form-group full-width">
            <label for="nome-medico">Nome do Médico</label>
            <input type="text" id="nome-medico" placeholder="Dr(a). Nome Sobrenome" onchange="salvarDadosMedico()" required>
        </div>
        <div class="form-group">
            <label for="crm">CRM / UF</label>
            <input type="text" id="crm" placeholder="CRM-XX 12345" onchange="salvarDadosMedico()" required>
        </div>
        <div class="form-group">
            <label for="telefone-medico">Telefone</label>
            <input type="text" id="telefone-medico" placeholder="Ex: (45) 99999-0000" onchange="salvarDadosMedico()">
        </div>
    </div>
    
    <div class="row">
        <div class="form-group full-width">
            <label for="endereco-medico">Endereço de Atendimento</label>
            <input type="text" id="endereco-medico" placeholder="Rua, Número - Bairro" onchange="salvarDadosMedico()" required>
        </div>
        <div class="form-group">
            <label for="cidade-atendimento">Cidade de Atendimento</label>
            <input type="text" id="cidade-atendimento" placeholder="Ex: Toledo - PR" onchange="salvarDadosMedico()" required>
        </div>
    </div>

    <hr style="margin: 20px 0;">

    <h2>Dados do Paciente</h2>

    <div class="form-group">
        <label for="nome-paciente">Nome Completo do Paciente</label>
        <input type="text" id="nome-paciente" required>
    </div>
    <div class="form-group">
        <label for="endereco-paciente">Endereço do Paciente (Opcional)</label>
        <input type="text" id="endereco-paciente" placeholder="Rua, Número, Bairro, Cidade/UF">
    </div>

    <hr style="margin: 20px 0;">

    <h2>Prescrição (Máx. 8 Itens)</h2>
    
    <button id="toggle-prescricao" class="btn-acao" onclick="togglePrescricaoMode()">Mudar para Texto Livre</button>

    <div id="prescricao-fields">
        <div class="medicamento-item cabecalho-medicamento">
            <div class="med-col-med"><label>Medicamento</label></div>
            <div class="med-col-qnt"><label>Qtd.</label></div>
            <div class="med-col-pos"><label>Posologia / Uso</label></div>
            <div class="med-col-check"><label>Uso Contínuo</label></div>
        </div>
        </div>
    <button id="add-medicamento" class="btn-acao" onclick="addMedicamento()">Adicionar Medicamento</button>
    
    <div id="prescricao-livre" style="display: none;">
        <div class="form-group">
            <label for="prescricao-texto-livre">Prescrição e Orientações (Texto Livre)</label>
            <textarea id="prescricao-texto-livre" placeholder="1. [Medicamento e Qtd.]&#10;   [Posologia]&#10;2. [Medicamento e Qtd.]&#10;   [Posologia]&#10;..."></textarea>
        </div>
    </div>
    
    <button id="print-button" class="btn-acao" onclick="gerarReceituario()">Gerar Receituário e Imprimir</button>
</div>

<div id="receituario-impresso"></div>

<script>
    const MAX_MEDICAMENTOS = 8; 
    let medCount = 0;
    let isTextoLivre = false; 

    // --- Funções de LocalStorage ---

    function salvarDadosMedico() {
        localStorage.setItem('nomeMedico', document.getElementById('nome-medico').value);
        localStorage.setItem('crm', document.getElementById('crm').value);
        localStorage.setItem('enderecoMedico', document.getElementById('endereco-medico').value);
        localStorage.setItem('cidadeAtendimento', document.getElementById('cidade-atendimento').value);
        localStorage.setItem('telefoneMedico', document.getElementById('telefone-medico').value);
    }

    function carregarDadosMedico() {
        document.getElementById('nome-medico').value = localStorage.getItem('nomeMedico') || '';
        document.getElementById('crm').value = localStorage.getItem('crm') || '';
        document.getElementById('endereco-medico').value = localStorage.getItem('enderecoMedico') || '';
        document.getElementById('cidade-atendimento').value = localStorage.getItem('cidadeAtendimento') || '';
        document.getElementById('telefone-medico').value = localStorage.getItem('telefoneMedico') || '';
        
        document.getElementById('prescricao-texto-livre').value = localStorage.getItem('prescricaoLivre') || '';

        if (localStorage.getItem('isTextoLivre') === 'true' && document.getElementById('prescricao-texto-livre').value) {
            togglePrescricaoMode(true); 
        } else {
            addMedicamento();
        }
    }
    
    // --- Funções do Formulário ---

    function novoReceituario() {
        document.getElementById('nome-paciente').value = '';
        document.getElementById('endereco-paciente').value = '';
        document.getElementById('controle-especial').checked = false;
        
        document.getElementById('prescricao-texto-livre').value = '';
        localStorage.removeItem('prescricaoLivre');

        if (!isTextoLivre) {
            const prescricaoFields = document.getElementById('prescricao-fields');
            document.querySelectorAll('.medicamento-item:not(.cabecalho-medicamento)').forEach(item => item.remove());
            medCount = 0;
            addMedicamento(); 
            document.getElementById('add-medicamento').disabled = false;
        }
    }

    function getDataAtual(formatar = true) {
        if (!formatar) return `<span class="data-manual"></span>`; 
        
        const date = new Date();
        const dia = String(date.getDate()).padStart(2, '0');
        const mes = String(date.getMonth() + 1).padStart(2, '0');
        const ano = date.getFullYear();
        return `${dia}/${mes}/${ano}`;
    }

    function togglePrescricaoMode(forceTextoLivre = false) {
        const fieldsContainer = document.getElementById('prescricao-fields');
        const livreContainer = document.getElementById('prescricao-livre');
        const addButton = document.getElementById('add-medicamento');
        const toggleButton = document.getElementById('toggle-prescricao');

        if (forceTextoLivre || !isTextoLivre) {
            // Mudar para Texto Livre
            fieldsContainer.style.display = 'none';
            addButton.style.display = 'none';
            livreContainer.style.display = 'block';
            toggleButton.textContent = 'Mudar para Campos Separados';
            isTextoLivre = true;
            localStorage.setItem('isTextoLivre', 'true');
        } else {
            // Mudar para Campos Separados
            livreContainer.style.display = 'none';
            fieldsContainer.style.display = 'block';
            addButton.style.display = 'block';
            toggleButton.textContent = 'Mudar para Texto Livre';
            isTextoLivre = false;
            localStorage.setItem('isTextoLivre', 'false');
        }
    }

    function addMedicamento() {
        if (medCount >= MAX_MEDICAMENTOS) {
            document.getElementById('add-medicamento').disabled = true;
            return;
        }

        medCount++;
        const container = document.getElementById('prescricao-fields');
        const item = document.createElement('div');
        item.className = 'medicamento-item';
        item.setAttribute('data-id', medCount);
        
        item.innerHTML = `
            <div class="med-col-med form-group">
                <input type="text" name="medicamento" placeholder="Ex: Rivotril 2mg (Comprimidos)" required>
            </div>
            <div class="med-col-qnt form-group">
                <input type="text" name="quantidade" placeholder="Ex: 30" required>
            </div>
            <div class="med-col-pos form-group">
                <input type="text" name="posologia" placeholder="Ex: Tomar 1 comprimido à noite." required>
            </div>
            <div class="med-col-check form-group">
                <input type="checkbox" name="uso-continuo" id="uso-continuo-${medCount}">
                <label for="uso-continuo-${medCount}" style="display:inline; font-weight:normal;">Sim</label>
                <button type="button" class="btn-remover" onclick="removerMedicamento(this.parentNode.parentNode)">X</button>
            </div>
        `;
        container.appendChild(item);
        
        if (medCount >= MAX_MEDICAMENTOS) {
            document.getElementById('add-medicamento').disabled = true;
        }
    }

    function removerMedicamento(item) {
        item.remove();
        medCount--;
        document.getElementById('add-medicamento').disabled = false;
        let index = 1;
        document.querySelectorAll('.medicamento-item:not(.cabecalho-medicamento)').forEach(el => {
            el.setAttribute('data-id', index++);
        });
    }

    // --- Componente de Identificação da Farmácia (HTML) ---

    const identificacaoFarmaciaHTML = `
        <div class="identificacao-farmacia">
            <div class="titulo">IDENTIFICAÇÃO DO COMPRADOR</div>
            <div class="bloco">
                <div class="campo-longo">Nome completo: </div>
                <div class="campo">RG: </div>
                <div class="campo">Org.Emissor: </div>
            </div>
             <div class="bloco">
                <div class="campo-longo">Endereço: </div>
                <div class="campo">Cidade/UF: </div>
                <div class="campo">Fone: </div>
            </div>
            
            <hr style="border-top: 1px dashed #000; margin: 8px 0;">

            <div class="titulo">IDENTIFICAÇÃO DO FORNECEDOR</div>
            
            <div class="bloco">
                <div class="campo-inteiro">Fornecedor: </div> 
            </div>
            
            <div class="bloco">
                <div class="campo-metade">Farmacêutico: </div>
                <div class="campo-metade">CRF NUMERO/UF: </div> 
            </div>
            
            <div class="bloco">
                <div class="campo-inteiro">Data do fornecimento: </div> 
            </div>
        </div>
    `;


    // --- Função de Geração e Impressão ---

    function gerarReceituario() {
        // 0. Validação e Coleta
        if (!document.getElementById('nome-paciente').value || !document.getElementById('cidade-atendimento').value || !document.getElementById('nome-medico').value || !document.getElementById('endereco-medico').value) {
            alert('Preencha os campos obrigatórios: Nome do Médico, CRM, Endereço de Atendimento, Cidade e Nome do Paciente.');
            return;
        }
        
        const isControleEspecial = document.getElementById('controle-especial').checked;
        const usarDataAutomatica = document.getElementById('data-automatica').checked;
        
        const nomeMedico = document.getElementById('nome-medico').value;
        const crm = document.getElementById('crm').value;
        const enderecoMedico = document.getElementById('endereco-medico').value;
        const cidadeAtendimento = document.getElementById('cidade-atendimento').value;
        const telefoneMedico = document.getElementById('telefone-medico').value;
        const nomePaciente = document.getElementById('nome-paciente').value;
        const enderecoPaciente = document.getElementById('endereco-paciente').value;
        
        const dataFormatada = getDataAtual(usarDataAutomatica);


        // 1. Geração do HTML de Prescrição
        let prescricaoConteudo = '';

        if (isTextoLivre) {
             // Modo Texto Livre
            localStorage.setItem('prescricaoLivre', document.getElementById('prescricao-texto-livre').value);
            const textoLivre = document.getElementById('prescricao-texto-livre').value.trim();
            if (!textoLivre) {
                 alert('A prescrição em texto livre não pode estar vazia.');
                 return;
            }
            prescricaoConteudo = `<div class="texto-livre-print">${textoLivre}</div>`;
        } else {
             // Modo Campos Separados
            const medicamentos = [];
            document.querySelectorAll('.medicamento-item:not(.cabecalho-medicamento)').forEach(item => {
                const med = item.querySelector('[name="medicamento"]').value;
                const qnt = item.querySelector('[name="quantidade"]').value;
                const pos = item.querySelector('[name="posologia"]').value;
                const usoCont = item.querySelector('[name="uso-continuo"]').checked;
                if (med && qnt && pos) { 
                     medicamentos.push({ med, qnt, pos, usoCont });
                }
            });

            if (medicamentos.length === 0) {
                 alert('Preencha pelo menos um item da prescrição ou use o modo Texto Livre.');
                 return;
            }

            // Numeração feita automaticamente pelo <ol>
            const listaHTML = medicamentos.map((m) => `
                <li>
                    <strong>${m.med} (${m.qnt})${m.usoCont ? `<span class="uso-continuo">(USO CONTÍNUO)</span>` : ''}</strong>
                    ${m.pos}
                </li>
            `).join('');

            prescricaoConteudo = `<ol>${listaHTML}</ol>`;
        }


        // 2. Função para gerar uma única via (HTML)
        function gerarVia(viaTipo = 'Comum', isControlado = false) {
            const titulo = isControlado ? 'RECEITUÁRIO MÉDICO DE CONTROLE ESPECIAL' : 'RECEITUÁRIO MÉDICO';
            const viaInfo = isControlado ? viaTipo : '';

            // Construção do cabeçalho
            const telefoneDisplay = telefoneMedico ? `<p>Telefone: ${telefoneMedico}</p>` : '';

            return `
                <div class="receituario">
                    ${isControlado ? `<span class="via-info">${viaInfo}</span>` : ''}
                    <div class="cabecalho">
                        <h1>${titulo}</h1>
                        <p>${enderecoMedico}</p>
                        ${telefoneDisplay}
                    </div>

                    <div class="dados-paciente">
                        <p><strong>Nome do Paciente:</strong> ${nomePaciente.toUpperCase()}</p>
                        ${enderecoPaciente ? `<p><strong>Endereço:</strong> ${enderecoPaciente.toUpperCase()}</p>` : ''}
                    </div>

                    <div class="prescricao-print">
                        ${prescricaoConteudo}
                    </div>
                    
                    ${isControleEspecial ? identificacaoFarmaciaHTML : ''}

                    <div class="assinatura">
                        <div class="data">
                            ${cidadeAtendimento}, ${dataFormatada}
                        </div>
                        <div class="bloco-medico">
                            <hr class="linha-assinatura">
                            <div class="medico-info">
                                ${nomeMedico}<br>
                                ${crm}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // 3. Injeção e Impressão
        const areaImpressa = document.getElementById('receituario-impresso');
        areaImpressa.innerHTML = '';

        if (isControleEspecial) {
            areaImpressa.innerHTML += gerarVia('1ª VIA - FARMÁCIA', true);
            areaImpressa.innerHTML += gerarVia('2ª VIA - PACIENTE', true);
        } else {
            areaImpressa.innerHTML += gerarVia('Comum', false);
        }

        window.print();
    }
</script>

</body>
</html>